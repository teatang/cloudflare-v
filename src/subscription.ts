import type { ServerNode } from './types';
import { PATH, VERSION } from './config';

/**
 * Generate VLESS URI link
 */
function generateVlessLink(node: ServerNode, userId: string, hostName: string): string {
	const security = node.isTls ? 'tls' : 'none';
	const sni = node.isTls ? `&sni=${hostName}` : '';
	const servername = node.isTls ? `servername: ${hostName}` : '';
	const tls = node.isTls ? `tls: true` : `tls: false`;

	return `vless://${userId}@${node.ip}:${node.port}?encryption=none&security=${security}${sni}&fp=randomized&type=ws&host=${hostName}&path=${encodeURIComponent(PATH)}#${node.name}_${node.ip}_${node.port}`;
}

/**
 * Generate base64 encoded share link
 */
export function generateShareLink(nodes: ServerNode[], userId: string, hostName: string): string {
	const links = nodes.map((node) => generateVlessLink(node, userId, hostName)).join('\n');
	return btoa(links);
}

/**
 * Generate Clash Meta configuration
 */
export function generateClashConfig(
	nodes: ServerNode[],
	userId: string,
	hostName: string
): string {
	const proxyList = nodes
		.map((node) => {
			const serverIp = node.ip.replace(/[\[\]]/g, '');
			const servername = node.isTls ? `\n  servername: ${hostName}` : '';
			return `
- name: ${node.name}_${node.ip}_${node.port}
  type: vless
  server: ${serverIp}
  port: ${node.port}
  uuid: ${userId}
  udp: false
  tls: ${node.isTls}
  network: ws
  ws-opts:
    path: "${PATH}"
    headers:
      Host: ${hostName}${servername}`;
		})
		.join('');

	const proxyNames = nodes.map((node) => `${node.name}_${node.ip}_${node.port}`).join('\n    - ');

	return `port: 7890
allow-lan: true
mode: rule
log-level: info
unified-delay: true
global-client-fingerprint: chrome
dns:
  enable: false
  listen: :53
  ipv6: true
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  default-nameserver:
    - 223.5.5.5
    - 114.114.114.114
    - 8.8.8.8
  nameserver:
    - https://dns.alidns.com/dns-query
    - https://doh.pub/dns-query
  fallback:
    - https://1.0.0.1/dns-query
    - tls://dns.google
  fallback-filter:
    geoip: true
    geoip-code: CN
    ipcidr:
      - 240.0.0.0/4

proxies:${proxyList}

proxy-groups:
- name: è´Ÿè½½å‡è¡¡
  type: load-balance
  url: http://www.gstatic.com/generate_204
  interval: 300
  proxies:
    - ${proxyNames}

- name: è‡ªåŠ¨é€‰æ‹©
  type: url-test
  url: http://www.gstatic.com/generate_204
  interval: 300
  tolerance: 50
  proxies:
    - ${proxyNames}

- name: ğŸŒé€‰æ‹©ä»£ç†
  type: select
  proxies:
    - è´Ÿè½½å‡è¡¡
    - è‡ªåŠ¨é€‰æ‹©
    - DIRECT
    - ${proxyNames}

rules:
  - GEOIP,LAN,DIRECT
  - GEOIP,CN,DIRECT
  - MATCH,ğŸŒé€‰æ‹©ä»£ç†`;
}

/**
 * Generate Sing-Box configuration
 */
export function generateSingBoxConfig(
	nodes: ServerNode[],
	userId: string,
	hostName: string
): string {
	const outbounds = nodes
		.map((node) => {
			const tlsConfig = node.isTls
				? `
		  tls: {
			enabled: true,
			server_name: "${hostName}",
			insecure: false,
			utls: {
			  enabled: true,
			  fingerprint: "chrome"
			}
		  }`
				: '';

			return `{
		  server: "${node.ip}",
		  server_port: ${node.port},
		  tag: "${node.name}_${node.ip}_${node.port}",
		  packet_encoding: "packetaddr",
		  transport: {
			headers: {
			  Host: [
				"${hostName}"
			  ]
			},
			"path": "${PATH}",
			"type": "ws"
		  },${tlsConfig}
		  type: "vless",
		  uuid: "${userId}"
		}`;
		})
		.join(',\n');

	const outboundNames = nodes.map((node) => `"${node.name}_${node.ip}_${node.port}"`).join(',\n');

	return `{
	  "log": {
		"disabled": false,
		"level": "info",
		"timestamp": true
	  },
	  "experimental": {
		"clash_api": {
		  "external_controller": "127.0.0.1:9090",
		  "external_ui": "ui",
		  "external_ui_download_url": "",
		  "external_ui_download_detour": "",
		  "secret": "",
		  "default_mode": "Rule"
		},
		"cache_file": {
		  "enabled": true,
		  "path": "cache.db",
		  "store_fakeip": true
		}
	  },
	  "dns": {
		"servers": [
		  {
			"tag": "proxydns",
			"address": "tls://8.8.8.8/dns-query",
			"detour": "select"
		  },
		  {
			"tag": "localdns",
			"address": "h3://223.5.5.5/dns-query",
			"detour": "direct"
		  },
		  {
			"tag": "dns_fakeip",
			"address": "fakeip"
		  }
		],
		"rules": [
		  {
			"outbound": "any",
			"server": "localdns",
			"disable_cache": true
		  },
		  {
			"clash_mode": "Global",
			"server": "proxydns"
		  },
		  {
			"clash_mode": "Direct",
			"server": "localdns"
		  },
		  {
			"rule_set": "geosite-cn",
			"server": "localdns"
		  },
		  {
			"rule_set": "geosite-geolocation-!cn",
			"server": "proxydns"
		  },
		  {
			"rule_set": "geosite-geolocation-!cn",
			"query_type": [
			  "A",
			  "AAAA"
			],
			"server": "dns_fakeip"
		  }
		],
		"fakeip": {
		  "enabled": true,
		  "inet4_range": "198.18.0.0/15",
		  "inet6_range": "fc00::/18"
		},
		"independent_cache": true,
		"final": "proxydns"
	  },
	  "inbounds": [
		{
		  "type": "tun",
          "tag": "tun-in",
		  "address": [
            "172.19.0.1/30",
		    "fd00::1/126"
      ],
		  "auto_route": true,
		  "strict_route": true,
		  "sniff": true,
		  "sniff_override_destination": true,
		  "domain_strategy": "prefer_ipv4"
		}
	  ],
	  "outbounds": [
		{
		  "tag": "select",
		  "type": "selector",
		  "default": "auto",
		  "outbounds": [
			"auto",
			${outboundNames}
		  ]
		},
		${outbounds},
		{
		  "tag": "direct",
		  "type": "direct"
		},
		{
		  "tag": "auto",
		  "type": "urltest",
		  "outbounds": [
			${outboundNames}
		  ],
		  "url": "https://www.gstatic.com/generate_204",
		  "interval": "1m",
		  "tolerance": 50,
		  "interrupt_exist_connections": false
		}
	  ],
	  "route": {
		"rule_set": [
		  {
			"tag": "geosite-geolocation-!cn",
			"type": "remote",
			"format": "binary",
			"url": "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@sing/geo/geosite/geolocation-!cn.srs",
			"download_detour": "select",
			"update_interval": "1d"
		  },
		  {
			"tag": "geosite-cn",
			"type": "remote",
			"format": "binary",
			"url": "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@sing/geo/geosite/geolocation-cn.srs",
			"download_detour": "select",
			"update_interval": "1d"
		  },
		  {
			"tag": "geoip-cn",
			"type": "remote",
			"format": "binary",
			"url": "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@sing/geo/geoip/cn.srs",
			"download_detour": "select",
			"update_interval": "1d"
		  }
		],
		"auto_detect_interface": true,
		"final": "select",
		"rules": [
          {
         "inbound": "tun-in",
          "action": "sniff"
          },
          {
          "protocol": "dns",
          "action": "hijack-dns"
           },
          {
           "port": 443,
          "network": "udp",
          "action": "reject"
          },
		  {
			"clash_mode": "Direct",
			"outbound": "direct"
		  },
		  {
			"clash_mode": "Global",
			"outbound": "select"
		  },
		  {
			"rule_set": "geoip-cn",
			"outbound": "direct"
		  },
		  {
			"rule_set": "geosite-cn",
			"outbound": "direct"
		  },
		  {
			"ip_is_private": true,
			"outbound": "direct"
		  },
		  {
			"rule_set": "geosite-geolocation-!cn",
			"outbound": "select"
		  }
		]
	  },
	  "ntp": {
		"enabled": true,
		"server": "time.apple.com",
		"server_port": 123,
		"interval": "30m",
		"detour": "direct"
	  }
	}`;
}

/**
 * Generate HTML page for node configuration display
 */
export function generateConfigPage(
	userId: string,
	cdnIp: string,
	httpNodes: ServerNode[],
	httpsNodes: ServerNode[],
	hostName: string
): string {
	// Generate single node links
	const wsNode = `vless://${userId}@${cdnIp}:8880?encryption=none&security=none&type=ws&host=${hostName}&path=%2F%3Fed%3D2560#${hostName}`;
	const wsTlsNode = `vless://${userId}@${cdnIp}:8443?encryption=none&security=tls&type=ws&host=${hostName}&sni=${hostName}&fp=random&path=%2F%3Fed%3D2560#${hostName}`;

	// Generate share links
	const allShareLink = generateShareLink([...httpNodes, ...httpsNodes], userId, hostName);
	const tlsShareLink = generateShareLink(httpsNodes, userId, hostName);

	// Generate subscription URLs
	const tyUrl = `https://${hostName}/${userId}/ty`;
	const clUrl = `https://${hostName}/${userId}/cl`;
	const sbUrl = `https://${hostName}/${userId}/sb`;
	const ptyUrl = `https://${hostName}/${userId}/pty`;
	const pclUrl = `https://${hostName}/${userId}/pcl`;
	const psbUrl = `https://${hostName}/${userId}/psb`;

	const note = `æ³¨æ„ï¼šProxyIPä½¿ç”¨nat64è‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€è®¾ç½®`;

	const noteshow = note.replace(/\n/g, '<br>');

	const isWorkersDev = hostName.includes('workers.dev');

	const displayHtml = `
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<style>
.limited-width {
    max-width: 200px;
    overflow: auto;
    word-wrap: break-word;
}
</style>
</head>
<script>
function copyToClipboard(text) {
  const input = document.createElement('textarea');
  input.style.position = 'fixed';
  input.style.opacity = 0;
  input.value = text;
  document.body.appendChild(input);
  input.select();
  document.execCommand('Copy');
  document.body.removeChild(input);
  alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}
</script>`;

	if (isWorkersDev) {
		return `${displayHtml}
<body>
<br>
<br>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Cloudflare-workers/pages-VLESSä»£ç†è„šæœ¬ ${VERSION}</h1>
	    <hr>
            <p>${noteshow}</p>
            <hr>
	    <hr>
	    <hr>
            <br>
            <br>
            <h3>1ï¼šCF-workers-VLESS+wsèŠ‚ç‚¹</h3>
			<table class="table">
				<thead>
					<tr>
						<th>èŠ‚ç‚¹ç‰¹è‰²ï¼š</th>
						<th>å•èŠ‚ç‚¹é“¾æ¥å¦‚ä¸‹ï¼š</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td class="limited-width">å…³é—­äº†TLSåŠ å¯†ï¼Œæ— è§†åŸŸåé˜»æ–­</td>
						<td class="limited-width">${wsNode}</td>
						<td><button class="btn btn-primary" onclick="copyToClipboard('${wsNode}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
					</tr>
				</tbody>
			</table>
            <h5>å®¢æˆ·ç«¯å‚æ•°å¦‚ä¸‹ï¼š</h5>
            <ul>
                <li>å®¢æˆ·ç«¯åœ°å€(address)ï¼šè‡ªå®šä¹‰çš„åŸŸå æˆ–è€… ä¼˜é€‰åŸŸå æˆ–è€… ä¼˜é€‰IP æˆ–è€… åä»£IP</li>
                <li>ç«¯å£(port)ï¼š7ä¸ªhttpç«¯å£å¯ä»»æ„é€‰æ‹©(80ã€8080ã€8880ã€2052ã€2082ã€2086ã€2095)ï¼Œæˆ–åä»£IPå¯¹åº”ç«¯å£</li>
                <li>ç”¨æˆ·ID(uuid)ï¼š${userId}</li>
                <li>ä¼ è¾“åè®®(network)ï¼šws æˆ–è€… websocket</li>
                <li>ä¼ªè£…åŸŸå(host)ï¼š${hostName}</li>
                <li>è·¯å¾„(path)ï¼š${PATH}</li>
				<li>ä¼ è¾“å®‰å…¨(TLS)ï¼šå…³é—­</li>
            </ul>
            <hr>
			<hr>
			<hr>
            <br>
            <br>
            <h3>2ï¼šCF-workers-VLESS+ws+tlsèŠ‚ç‚¹</h3>
			<table class="table">
				<thead>
					<tr>
						<th>èŠ‚ç‚¹ç‰¹è‰²ï¼š</th>
						<th>å•èŠ‚ç‚¹é“¾æ¥å¦‚ä¸‹ï¼š</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td class="limited-width">å¯ç”¨äº†TLSåŠ å¯†ï¼Œ<br>å¦‚æœå®¢æˆ·ç«¯æ”¯æŒåˆ†ç‰‡(Fragment)åŠŸèƒ½ï¼Œå»ºè®®å¼€å¯ï¼Œé˜²æ­¢åŸŸåé˜»æ–­</td>
						<td class="limited-width">${wsTlsNode}</td>
						<td><button class="btn btn-primary" onclick="copyToClipboard('${wsTlsNode}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
					</tr>
				</tbody>
			</table>
            <h5>å®¢æˆ·ç«¯å‚æ•°å¦‚ä¸‹ï¼š</h5>
            <ul>
                <li>å®¢æˆ·ç«¯åœ°å€(address)ï¼šè‡ªå®šä¹‰çš„åŸŸå æˆ–è€… ä¼˜é€‰åŸŸå æˆ–è€… ä¼˜é€‰IP æˆ–è€… åä»£IP</li>
                <li>ç«¯å£(port)ï¼š6ä¸ªhttpsç«¯å£å¯ä»»æ„é€‰æ‹©(443ã€8443ã€2053ã€2083ã€2087ã€2096)ï¼Œæˆ–åä»£IPå¯¹åº”ç«¯å£</li>
                <li>ç”¨æˆ·ID(uuid)ï¼š${userId}</li>
                <li>ä¼ è¾“åè®®(network)ï¼šws æˆ–è€… websocket</li>
                <li>ä¼ªè£…åŸŸå(host)ï¼š${hostName}</li>
                <li>è·¯å¾„(path)ï¼š${PATH}</li>
                <li>ä¼ è¾“å®‰å…¨(TLS)ï¼šå¼€å¯</li>
                <li>è·³è¿‡è¯ä¹¦éªŒè¯(allowlnsecure)ï¼šfalse</li>
			</ul>
			<hr>
			<hr>
			<hr>
			<br>
			<br>
			<h3>3ï¼šèšåˆé€šç”¨ã€Clash-metaã€Sing-boxè®¢é˜…é“¾æ¥å¦‚ä¸‹ï¼š</h3>
			<hr>
			<p>æ³¨æ„ï¼š<br>1ã€é»˜è®¤æ¯ä¸ªè®¢é˜…é“¾æ¥åŒ…å«TLS+éTLSå…±13ä¸ªç«¯å£èŠ‚ç‚¹<br>2ã€å½“å‰workersåŸŸåä½œä¸ºè®¢é˜…é“¾æ¥ï¼Œéœ€é€šè¿‡ä»£ç†è¿›è¡Œè®¢é˜…æ›´æ–°<br>3ã€å¦‚ä½¿ç”¨çš„å®¢æˆ·ç«¯ä¸æ”¯æŒåˆ†ç‰‡åŠŸèƒ½ï¼Œåˆ™TLSèŠ‚ç‚¹ä¸å¯ç”¨</p>
			<hr>
			<table class="table">
					<thead>
						<tr>
							<th>èšåˆé€šç”¨åˆ†äº«é“¾æ¥ (å¯ç›´æ¥å¯¼å…¥å®¢æˆ·ç«¯)ï¼š</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td><button class="btn btn-primary" onclick="copyToClipboard('${allShareLink}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
						</tr>
					</tbody>
				</table>
			<table class="table">
					<thead>
						<tr>
							<th>èšåˆé€šç”¨è®¢é˜…é“¾æ¥ï¼š</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="limited-width">${tyUrl}</td>
							<td><button class="btn btn-primary" onclick="copyToClipboard('${tyUrl}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
						</tr>
					</tbody>
				</table>
				<table class="table">
						<thead>
							<tr>
								<th>Clash-metaè®¢é˜…é“¾æ¥ï¼š</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="limited-width">${clUrl}</td>
								<td><button class="btn btn-primary" onclick="copyToClipboard('${clUrl}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
							</tr>
						</tbody>
					</table>
					<table class="table">
					<thead>
						<tr>
							<th>Sing-boxè®¢é˜…é“¾æ¥ï¼š</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="limited-width">${sbUrl}</td>
							<td><button class="btn btn-primary" onclick="copyToClipboard('${sbUrl}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
						</tr>
					</tbody>
				</table>
				<br>
				<br>
        </div>
    </div>
</div>
</body>`;
	} else {
		return `${displayHtml}
<body>
<br>
<br>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Cloudflare-workers/pages-VLESSä»£ç†è„šæœ¬ ${VERSION}</h1>
			<hr>
            <p>${noteshow}</p>
            <hr>
			<hr>
			<hr>
            <br>
            <br>
            <h3>1ï¼šCF-pages/workers/è‡ªå®šä¹‰åŸŸ-VLESS+ws+tlsèŠ‚ç‚¹</h3>
			<table class="table">
				<thead>
					<tr>
						<th>èŠ‚ç‚¹ç‰¹è‰²ï¼š</th>
						<th>å•èŠ‚ç‚¹é“¾æ¥å¦‚ä¸‹ï¼š</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td class="limited-width">å¯ç”¨äº†TLSåŠ å¯†ï¼Œ<br>å¦‚æœå®¢æˆ·ç«¯æ”¯æŒåˆ†ç‰‡(Fragment)åŠŸèƒ½ï¼Œå¯å¼€å¯ï¼Œé˜²æ­¢åŸŸåé˜»æ–­</td>
						<td class="limited-width">${wsTlsNode}</td>
						<td><button class="btn btn-primary" onclick="copyToClipboard('${wsTlsNode}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
					</tr>
				</tbody>
			</table>
            <h5>å®¢æˆ·ç«¯å‚æ•°å¦‚ä¸‹ï¼š</h5>
            <ul>
                <li>å®¢æˆ·ç«¯åœ°å€(address)ï¼šè‡ªå®šä¹‰çš„åŸŸå æˆ–è€… ä¼˜é€‰åŸŸå æˆ–è€… ä¼˜é€‰IP æˆ–è€… åä»£IP</li>
                <li>ç«¯å£(port)ï¼š6ä¸ªhttpsç«¯å£å¯ä»»æ„é€‰æ‹©(443ã€8443ã€2053ã€2083ã€2087ã€2096)ï¼Œæˆ–åä»£IPå¯¹åº”ç«¯å£</li>
                <li>ç”¨æˆ·ID(uuid)ï¼š${userId}</li>
                <li>ä¼ è¾“åè®®(network)ï¼šws æˆ–è€… websocket</li>
                <li>ä¼ªè£…åŸŸå(host)ï¼š${hostName}</li>
                <li>è·¯å¾„(path)ï¼š${PATH}</li>
                <li>ä¼ è¾“å®‰å…¨(TLS)ï¼šå¼€å¯</li>
                <li>è·³è¿‡è¯ä¹¦éªŒè¯(allowlnsecure)ï¼šfalse</li>
			</ul>
            <hr>
			<hr>
			<hr>
            <br>
            <br>
			<h3>2ï¼šèšåˆé€šç”¨ã€Clash-metaã€Sing-boxè®¢é˜…é“¾æ¥å¦‚ä¸‹ï¼š</h3>
			<hr>
			<p>æ³¨æ„ï¼šä»¥ä¸‹è®¢é˜…é“¾æ¥ä»…6ä¸ªTLSç«¯å£èŠ‚ç‚¹</p>
			<hr>
			<table class="table">
					<thead>
						<tr>
							<th>èšåˆé€šç”¨åˆ†äº«é“¾æ¥ (å¯ç›´æ¥å¯¼å…¥å®¢æˆ·ç«¯)ï¼š</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td><button class="btn btn-primary" onclick="copyToClipboard('${tlsShareLink}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
						</tr>
					</tbody>
				</table>
			<table class="table">
					<thead>
						<tr>
							<th>èšåˆé€šç”¨è®¢é˜…é“¾æ¥ï¼š</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="limited-width">${ptyUrl}</td>
							<td><button class="btn btn-primary" onclick="copyToClipboard('${ptyUrl}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
						</tr>
					</tbody>
				</table>
				<table class="table">
						<thead>
							<tr>
								<th>Clash-metaè®¢é˜…é“¾æ¥ï¼š</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="limited-width">${pclUrl}</td>
								<td><button class="btn btn-primary" onclick="copyToClipboard('${pclUrl}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
							</tr>
						</tbody>
					</table>
					<table class="table">
					<thead>
						<tr>
							<th>Sing-boxè®¢é˜…é“¾æ¥ï¼š</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="limited-width">${psbUrl}</td>
							<td><button class="btn btn-primary" onclick="copyToClipboard('${psbUrl}')">ç‚¹å‡»å¤åˆ¶é“¾æ¥</button></td>
						</tr>
					</tbody>
				</table>
				<br>
				<br>
        </div>
    </div>
</div>
</body>`;
	}
}
